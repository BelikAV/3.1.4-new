<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text text-white">Admin Panel</span>
        <form th:action="@{/logout}" method="post">
            <button class="btn btn-outline-light" type="submit">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-2 bg-white border-end" style="min-height: 100vh;">
            <ul class="nav flex-column mt-3">
                <li class="nav-item"><a class="nav-link active">Admin</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user}">User</a></li>
            </ul>
        </div>
        <div class="col-10">
            <h2 class="mt-3">Admin panel</h2>
            <ul class="nav nav-tabs mt-3" id="adminTabs">
                <li class="nav-item">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users">Users table</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="newuser-tab" data-bs-toggle="tab" data-bs-target="#newuser">New User</button>
                </li>
            </ul>
            <div class="tab-content" id="adminTabsContent">
                <div class="tab-pane fade show active p-3" id="users">
                    <h5>All users <span class="badge bg-primary" id="usersCount">0</span></h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="usersTable">
                            <thead class="table-dark">
                            <tr><th>ID</th><th>Username</th><th>Name</th><th>Age</th><th>Email</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="usersTbody">
                            <tr><td colspan="6" class="text-center">Загрузка...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade p-3" id="newuser">
                    <h5>Add new user</h5>
                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="addUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="addPassword" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" id="addName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Age</label>
                                    <input type="number" class="form-control" id="addAge" min="1" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="addEmail">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Add user</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" id="editAge" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password (leave empty)</label>
                        <input type="password" class="form-control" id="editPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Delete user</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteUserForm">
                <div class="modal-body">
                    <input type="hidden" id="deleteId">
                    <div class="alert alert-danger">Вы уверены?</div>
                    <div class="mb-3">
                        <label>Username</label>
                        <input type="text" class="form-control" id="deleteUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label>Name</label>
                        <input type="text" class="form-control" id="deleteName" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let users = [];
    console.log('JS загружен!'); // ← Проверь в F12 Console

    $(document).ready(function() {
        console.log('DOM готов!');
        loadUsers();

        $('#addUserForm').on('submit', function(e) {
            e.preventDefault();
            addUser();
        });
        $('#editUserForm').on('submit', function(e) {
            e.preventDefault();
            saveEdit();
        });
        $('#deleteUserForm').on('submit', function(e) {
            e.preventDefault();
            confirmDelete();
        });
    });

    function loadUsers() {
        console.log('Загрузка пользователей...');
        fetch('/api/admin/users')
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Данные:', data);
                users = data;
                updateTable();
                $('#usersCount').text(users.length);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                $('#usersTbody').html('<tr><td colspan="6" class="text-danger text-center">Ошибка API</td></tr>');
            });
    }

    function updateTable() {
        const tbody = $('#usersTbody');
        tbody.empty();

        if (users.length === 0) {
            tbody.html('<tr><td colspan="6" class="text-center">Нет пользователей</td></tr>');
            return;
        }

        users.forEach(user => {
            tbody.append(`
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.name}</td>
                <td>${user.age}</td>
                <td>${user.email || ''}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="editUser(${user.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="showDeleteModal(${user.id})">Delete</button>
                </td>
            </tr>
        `);
        });
    }

    function editUser(id) {
        const user = users.find(u => u.id == id);
        $('#editId').val(user.id);
        $('#editUsername').val(user.username);
        $('#editName').val(user.name);
        $('#editAge').val(user.age);
        $('#editEmail').val(user.email || '');
        $('#editPassword').val('');
        $('#editModal').modal('show');
    }

    function saveEdit() {
        const id = $('#editId').val();
        const userData = {
            username: $('#editUsername').val(),
            name: $('#editName').val(),
            age: parseInt($('#editAge').val()),
            email: $('#editEmail').val()
        };
        const password = $('#editPassword').val();
        if (password) userData.password = password;

        fetch(`/api/admin/users/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(userData)
        }).then(response => {
            if (response.ok) {
                loadUsers();
                $('#editModal').modal('hide');
            } else {
                alert('Ошибка обновления');
            }
        }).catch(error => console.error(error));
    }

    function showDeleteModal(id) {
        const user = users.find(u => u.id == id);
        $('#deleteId').val(user.id);
        $('#deleteUsername').val(user.username);
        $('#deleteName').val(user.name);
        $('#deleteModal').modal('show');
    }

    function confirmDelete() {
        const id = $('#deleteId').val();
        fetch(`/api/admin/users/${id}`, {method: 'DELETE'})
            .then(response => {
                if (response.ok) {
                    loadUsers();
                    $('#deleteModal').modal('hide');
                } else {
                    alert('Ошибка удаления');
                }
            })
            .catch(error => console.error(error));
    }

    function addUser() {
        const userData = {
            username: $('#addUsername').val(),
            password: $('#addPassword').val(),
            name: $('#addName').val(),
            age: parseInt($('#addAge').val()),
            email: $('#addEmail').val()
        };

        fetch('/api/admin/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(userData)
        }).then(response => {
            if (response.ok) {
                loadUsers();
                $('#addUserForm')[0].reset();
            } else {
                alert('Ошибка создания');
            }
        }).catch(error => console.error(error));
    }
    $(document).ready(function() {
        console.log('DOM готов!');
        loadUsers();

        // периодическое авто‑обновление каждые 5 секунд
        setInterval(loadUsers, 10000);

        $('#addUserForm').on('submit', function(e) {
            e.preventDefault();
            addUser();
        });

        $('#editUserForm').on('submit', function(e) {
            e.preventDefault();
            saveEdit();
        });

        $('#deleteUserForm').on('submit', function(e) {
            e.preventDefault();
            confirmDelete();
        });
    });
</script>
</body>
</html>
